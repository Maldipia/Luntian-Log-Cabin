<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Amadeo Marketplace</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; padding: 15px 20px; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 700; }
        .logo a { color: white; text-decoration: none; }
        .header-nav { display: flex; gap: 20px; }
        .header-nav a { color: white; text-decoration: none; opacity: 0.9; }
        .header-nav a:hover { opacity: 1; }
        
        .main-container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; display: grid; grid-template-columns: 280px 1fr; gap: 30px; }
        
        /* Sidebar */
        .sidebar { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); height: fit-content; position: sticky; top: 30px; }
        .user-info { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #eee; margin-bottom: 20px; }
        .user-avatar { width: 80px; height: 80px; background: linear-gradient(135deg, #0f766e, #14b8a6); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: white; font-weight: 700; margin: 0 auto 15px; }
        .user-info h3 { color: #0f766e; margin-bottom: 5px; }
        .user-info p { color: #666; font-size: 14px; }
        
        .sidebar-menu { }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: #666; text-decoration: none; border-radius: 10px; transition: all 0.3s; cursor: pointer; }
        .menu-item:hover { background: #f0fdfa; color: #0f766e; }
        .menu-item.active { background: #f0fdfa; color: #0f766e; font-weight: 600; }
        
        .logout-btn { width: 100%; padding: 12px; background: #fee2e2; color: #dc2626; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; margin-top: 20px; }
        .logout-btn:hover { background: #fecaca; }
        
        /* Content */
        .content-section { display: none; }
        .content-section.active { display: block; }
        
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .section-header h1 { color: #0f766e; font-size: 28px; }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .value { font-size: 32px; font-weight: 700; color: #0f766e; }
        .stat-card .label { font-size: 14px; color: #666; margin-top: 5px; }
        
        /* Orders */
        .orders-filter { display: flex; gap: 10px; margin-bottom: 20px; }
        .filter-btn { padding: 8px 20px; background: #f0f0f0; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .filter-btn:hover { background: #e0e0e0; }
        .filter-btn.active { background: #0f766e; color: white; }
        
        .orders-list { display: flex; flex-direction: column; gap: 15px; }
        .order-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .order-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .order-id { font-family: monospace; font-size: 16px; font-weight: 700; color: #0f766e; background: #f0fdfa; padding: 5px 12px; border-radius: 6px; }
        .order-date { font-size: 13px; color: #666; }
        .order-status { padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-confirmed { background: #dbeafe; color: #1e40af; }
        .status-preparing { background: #e9d5ff; color: #7c3aed; }
        .status-delivery { background: #fce7f3; color: #be185d; }
        .status-delivered, .status-completed { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #dc2626; }
        
        .order-items { color: #666; font-size: 14px; margin-bottom: 15px; }
        .order-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #eee; flex-wrap: wrap; gap: 10px; }
        .order-total { font-size: 18px; font-weight: 700; color: #0f766e; }
        .order-payment { font-size: 13px; color: #666; }
        .order-payment .badge { display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; }
        .payment-cod { background: #e5e7eb; color: #374151; }
        .payment-gcash { background: #dbeafe; color: #1e40af; }
        .order-actions { display: flex; gap: 10px; }
        .order-actions a, .order-actions button { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; text-decoration: none; cursor: pointer; border: none; }
        .btn-track { background: #0f766e; color: white; }
        .btn-track:hover { background: #134e4a; }
        .btn-cancel { background: #fee2e2; color: #dc2626; }
        .btn-cancel:hover { background: #fecaca; }
        
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state .icon { font-size: 60px; margin-bottom: 20px; }
        .empty-state h3 { color: #666; margin-bottom: 10px; }
        .empty-state p { color: #999; margin-bottom: 20px; }
        .empty-state a { display: inline-block; padding: 12px 30px; background: #0f766e; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; }
        
        /* Profile */
        .profile-card { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .profile-card h2 { color: #0f766e; margin-bottom: 25px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #0f766e; }
        .save-btn { padding: 12px 30px; background: #0f766e; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .save-btn:hover { background: #134e4a; }
        
        /* Login prompt */
        .login-prompt { max-width: 500px; margin: 100px auto; text-align: center; background: white; padding: 50px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .login-prompt .icon { font-size: 60px; margin-bottom: 20px; }
        .login-prompt h2 { color: #0f766e; margin-bottom: 10px; }
        .login-prompt p { color: #666; margin-bottom: 25px; }
        .login-prompt a { display: inline-block; padding: 12px 30px; background: #0f766e; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; margin: 5px; }
        .login-prompt a.secondary { background: white; color: #0f766e; border: 2px solid #0f766e; }
        
        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
            .sidebar { position: static; }
            .stats-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo"><a href="/">Amadeo Marketplace</a></div>
            <nav class="header-nav">
                <a href="/">Shop</a>
                <a href="/track">Track Order</a>
            </nav>
        </div>
    </header>
    
    <!-- Login Prompt (shown if not logged in) -->
    <div class="login-prompt" id="loginPrompt" style="display:none;">
        <div class="icon">üë§</div>
        <h2>Welcome!</h2>
        <p>Please login or create an account to view your orders and manage your profile.</p>
        <a href="/login">Login</a>
        <a href="/signup" class="secondary">Sign Up</a>
    </div>
    
    <!-- Main Content (shown if logged in) -->
    <div class="main-container" id="mainContent">
        <aside class="sidebar">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">?</div>
                <h3 id="userName">User</h3>
                <p id="userEmail">email@example.com</p>
            </div>
            
            <nav class="sidebar-menu">
                <a class="menu-item active" onclick="showSection('orders', this)">
                    <span>üì¶</span> My Orders
                </a>
                <a class="menu-item" onclick="showSection('profile', this)">
                    <span>üë§</span> Profile
                </a>
            </nav>
            
            <button class="logout-btn" onclick="logout()">Logout</button>
        </aside>
        
        <main>
            <!-- Orders Section -->
            <section class="content-section active" id="ordersSection">
                <div class="section-header">
                    <h1>My Orders</h1>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" id="totalOrders">0</div>
                        <div class="label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="activeOrders">0</div>
                        <div class="label">Active Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="completedOrders">0</div>
                        <div class="label">Completed</div>
                    </div>
                </div>
                
                <div class="orders-filter">
                    <button class="filter-btn active" onclick="filterOrders('all', this)">All</button>
                    <button class="filter-btn" onclick="filterOrders('active', this)">Active</button>
                    <button class="filter-btn" onclick="filterOrders('completed', this)">Completed</button>
                    <button class="filter-btn" onclick="filterOrders('cancelled', this)">Cancelled</button>
                </div>
                
                <div class="orders-list" id="ordersList">
                    <div class="empty-state">
                        <div class="icon">üì¶</div>
                        <h3>Loading orders...</h3>
                    </div>
                </div>
            </section>
            
            <!-- Profile Section -->
            <section class="content-section" id="profileSection">
                <div class="section-header">
                    <h1>My Profile</h1>
                </div>
                
                <div class="profile-card">
                    <h2>Personal Information</h2>
                    <form id="profileForm" onsubmit="saveProfile(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="profileName" required>
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" id="profilePhone" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="profileEmail">
                        </div>
                        <div class="form-group">
                            <label>Default Delivery Address</label>
                            <textarea id="profileAddress" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Barangay</label>
                            <select id="profileBarangay">
                                <option value="">Select Barangay</option>
                                <option value="Poblacion">Poblacion</option>
                                <option value="Dagatan">Dagatan</option>
                                <option value="Halang">Halang</option>
                                <option value="Iba">Iba</option>
                                <option value="Kaysuyo">Kaysuyo</option>
                                <option value="Lalaan I">Lalaan I</option>
                                <option value="Lalaan II">Lalaan II</option>
                                <option value="Maymangga">Maymangga</option>
                                <option value="Minantok East">Minantok East</option>
                                <option value="Minantok West">Minantok West</option>
                                <option value="Pangil">Pangil</option>
                                <option value="Salaban">Salaban</option>
                                <option value="Talon">Talon</option>
                                <option value="Tamlong">Tamlong</option>
                                <option value="Banaybanay">Banaybanay</option>
                                <option value="Buho">Buho</option>
                                <option value="Kabigting">Kabigting</option>
                                <option value="Labac">Labac</option>
                                <option value="Luksuhin">Luksuhin</option>
                                <option value="Maitim">Maitim</option>
                                <option value="Mahabang Kahoy">Mahabang Kahoy</option>
                                <option value="Paligawan">Paligawan</option>
                                <option value="San Agustin">San Agustin</option>
                                <option value="Tiambong">Tiambong</option>
                            </select>
                        </div>
                        <button type="submit" class="save-btn">Save Changes</button>
                    </form>
                </div>
            </section>
        </main>
    </div>
    
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzFo0Y_OPRZ4h9pr8lqqShRgT7NCnPSVTXf96LJ_x6DjKqUKzAAzwFkbq8NjGZAJVmncw/exec';
        
        let userData = null;
        let allOrders = [];
        let currentFilter = 'all';
        
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
        });
        
        function checkAuth() {
            const user = sessionStorage.getItem('amadeo_user') || localStorage.getItem('amadeo_user');
            const loginType = sessionStorage.getItem('amadeo_login_type') || localStorage.getItem('amadeo_login_type');
            
            // Redirect merchants to dashboard
            if (loginType === 'merchant') {
                window.location.href = '/dashboard';
                return;
            }
            
            if (!user) {
                document.getElementById('loginPrompt').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                return;
            }
            
            userData = JSON.parse(user);
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('mainContent').style.display = 'grid';
            
            // Set user info
            document.getElementById('userName').textContent = userData.name || 'User';
            document.getElementById('userEmail').textContent = userData.email || userData.phone || '';
            document.getElementById('userAvatar').textContent = (userData.name || 'U').charAt(0).toUpperCase();
            
            // Load profile
            document.getElementById('profileName').value = userData.name || '';
            document.getElementById('profilePhone').value = userData.phone || '';
            document.getElementById('profileEmail').value = userData.email || '';
            document.getElementById('profileAddress').value = userData.address || '';
            document.getElementById('profileBarangay').value = userData.barangay || '';
            
            loadOrders();
        }
        
        function logout() {
            sessionStorage.clear();
            localStorage.removeItem('amadeo_user');
            localStorage.removeItem('amadeo_token');
            localStorage.removeItem('amadeo_login_type');
            window.location.href = '/';
        }
        
        async function loadOrders() {
            try {
                // Get all orders and filter by customer phone or email
                const response = await fetch(SCRIPT_URL + '?action=getOrders');
                const data = await response.json();
                
                if (data.success) {
                    // Filter orders for this customer
                    const customerPhone = userData.phone;
                    const customerEmail = userData.email;
                    
                    allOrders = (data.data || []).filter(order => {
                        return order.CustomerPhone === customerPhone || 
                               (customerEmail && order.CustomerEmail === customerEmail);
                    });
                    
                    // Sort by date (newest first)
                    allOrders.sort((a, b) => new Date(b.CreatedAt) - new Date(a.CreatedAt));
                    
                    updateStats();
                    renderOrders();
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersList').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <h3>Unable to load orders</h3>
                        <p>Please try again later</p>
                    </div>
                `;
            }
        }
        
        function updateStats() {
            const activeStatuses = ['Pending', 'Confirmed', 'Preparing', 'Out for Delivery'];
            const completedStatuses = ['Delivered', 'Completed'];
            
            document.getElementById('totalOrders').textContent = allOrders.length;
            document.getElementById('activeOrders').textContent = allOrders.filter(o => activeStatuses.includes(o.OrderStatus)).length;
            document.getElementById('completedOrders').textContent = allOrders.filter(o => completedStatuses.includes(o.OrderStatus)).length;
        }
        
        function filterOrders(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            renderOrders();
        }
        
        function renderOrders() {
            let orders = [...allOrders];
            
            // Apply filter
            if (currentFilter === 'active') {
                orders = orders.filter(o => ['Pending', 'Confirmed', 'Preparing', 'Out for Delivery'].includes(o.OrderStatus));
            } else if (currentFilter === 'completed') {
                orders = orders.filter(o => ['Delivered', 'Completed'].includes(o.OrderStatus));
            } else if (currentFilter === 'cancelled') {
                orders = orders.filter(o => o.OrderStatus === 'Cancelled');
            }
            
            if (orders.length === 0) {
                document.getElementById('ordersList').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì¶</div>
                        <h3>No orders found</h3>
                        <p>${currentFilter === 'all' ? "You haven't placed any orders yet" : "No " + currentFilter + " orders"}</p>
                        <a href="/">Start Shopping</a>
                    </div>
                `;
                return;
            }
            
            document.getElementById('ordersList').innerHTML = orders.map(order => {
                let items = [];
                try { items = JSON.parse(order.Items || '[]'); } catch(e) {}
                const itemNames = items.slice(0, 2).map(i => i.name).join(', ');
                const moreItems = items.length > 2 ? ` +${items.length - 2} more` : '';
                
                const statusClass = order.OrderStatus?.toLowerCase().replace(/ /g, '') || 'pending';
                const canCancel = order.OrderStatus === 'Pending';
                
                return `
                    <div class="order-card">
                        <div class="order-card-header">
                            <div>
                                <span class="order-id">${order.OrderId}</span>
                                <div class="order-date">${new Date(order.CreatedAt).toLocaleDateString('en-US', { 
                                    weekday: 'short', 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}</div>
                            </div>
                            <span class="order-status status-${statusClass}">${order.OrderStatus}</span>
                        </div>
                        <div class="order-items">${itemNames}${moreItems}</div>
                        <div class="order-footer">
                            <div>
                                <div class="order-total">P${(order.Total || 0).toLocaleString()}</div>
                                <div class="order-payment">
                                    <span class="badge payment-${order.PaymentMethod?.toLowerCase() || 'cod'}">${order.PaymentMethod || 'COD'}</span>
                                    ${order.PaymentMethod === 'GCash' ? ' (incl. 5% fee)' : ' (no fee)'}
                                </div>
                            </div>
                            <div class="order-actions">
                                <a href="/track?id=${order.OrderId}" class="btn-track">Track Order</a>
                                ${canCancel ? `<button class="btn-cancel" onclick="cancelOrder('${order.OrderId}')">Cancel</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function cancelOrder(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) return;
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateOrderStatus',
                        orderId: orderId,
                        status: 'Cancelled'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Order cancelled successfully');
                    loadOrders();
                } else {
                    alert('Error: ' + (result.error || 'Could not cancel order'));
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }
        
        function showSection(section, item) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(section + 'Section').classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            if (item) item.classList.add('active');
        }
        
        function saveProfile(e) {
            e.preventDefault();
            
            userData.name = document.getElementById('profileName').value;
            userData.phone = document.getElementById('profilePhone').value;
            userData.email = document.getElementById('profileEmail').value;
            userData.address = document.getElementById('profileAddress').value;
            userData.barangay = document.getElementById('profileBarangay').value;
            
            sessionStorage.setItem('amadeo_user', JSON.stringify(userData));
            localStorage.setItem('amadeo_user', JSON.stringify(userData));
            
            // Update sidebar
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userEmail').textContent = userData.email || userData.phone;
            document.getElementById('userAvatar').textContent = userData.name.charAt(0).toUpperCase();
            
            alert('Profile saved!');
        }
    </script>
</body>
</html>
