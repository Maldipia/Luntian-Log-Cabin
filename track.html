<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order - Amadeo Marketplace</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; padding: 15px 20px; }
        .header-content { max-width: 800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 700; }
        .logo a { color: white; text-decoration: none; }
        .header a { color: white; text-decoration: none; opacity: 0.9; }
        .header a:hover { opacity: 1; }
        
        .main-content { max-width: 800px; margin: 0 auto; padding: 30px 20px; }
        
        .search-card { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .search-card h1 { color: #0f766e; margin-bottom: 10px; font-size: 28px; }
        .search-card p { color: #666; margin-bottom: 20px; }
        .search-form { display: flex; gap: 10px; }
        .search-form input { flex: 1; padding: 15px 20px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; font-family: monospace; text-transform: uppercase; }
        .search-form input:focus { outline: none; border-color: #0f766e; }
        .search-form button { padding: 15px 30px; background: linear-gradient(135deg, #0f766e, #14b8a6); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .search-form button:hover { opacity: 0.9; }
        
        .order-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: none; }
        .order-card.active { display: block; }
        
        .order-header { background: linear-gradient(135deg, #0f766e, #14b8a6); color: white; padding: 25px; text-align: center; }
        .order-header .order-id-label { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .order-header .order-id { font-size: 32px; font-weight: 700; font-family: monospace; letter-spacing: 3px; }
        .order-header .order-date { font-size: 14px; opacity: 0.8; margin-top: 10px; }
        
        .status-section { padding: 30px; border-bottom: 1px solid #eee; }
        .status-section h3 { color: #0f766e; margin-bottom: 20px; font-size: 16px; }
        
        /* Timeline */
        .timeline { display: flex; justify-content: space-between; position: relative; padding: 0 10px; }
        .timeline::before { content: ''; position: absolute; top: 20px; left: 30px; right: 30px; height: 4px; background: #e5e7eb; z-index: 1; }
        .timeline-progress { position: absolute; top: 20px; left: 30px; height: 4px; background: #0f766e; z-index: 2; transition: width 0.5s; }
        .timeline-step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 3; flex: 1; }
        .timeline-dot { width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 10px; transition: all 0.3s; }
        .timeline-step.completed .timeline-dot { background: #0f766e; color: white; }
        .timeline-step.active .timeline-dot { background: #0f766e; color: white; box-shadow: 0 0 0 5px rgba(15,118,110,0.2); animation: pulse 2s infinite; }
        .timeline-step.cancelled .timeline-dot { background: #ef4444; color: white; }
        .timeline-label { font-size: 12px; color: #666; text-align: center; }
        .timeline-step.completed .timeline-label, .timeline-step.active .timeline-label { color: #0f766e; font-weight: 600; }
        
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 5px rgba(15,118,110,0.2); } 50% { box-shadow: 0 0 0 10px rgba(15,118,110,0.1); } }
        
        .current-status { text-align: center; margin-top: 30px; padding: 20px; background: #f0fdfa; border-radius: 12px; }
        .current-status .status-icon { font-size: 50px; margin-bottom: 10px; }
        .current-status .status-text { font-size: 20px; font-weight: 600; color: #0f766e; }
        .current-status .status-desc { color: #666; margin-top: 5px; }
        .current-status.cancelled { background: #fee2e2; }
        .current-status.cancelled .status-text { color: #dc2626; }
        
        .info-section { padding: 25px 30px; border-bottom: 1px solid #eee; }
        .info-section h3 { color: #0f766e; margin-bottom: 15px; font-size: 16px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .info-item { }
        .info-item label { font-size: 12px; color: #999; display: block; margin-bottom: 4px; }
        .info-item p { color: #333; font-size: 15px; }
        
        .items-section { padding: 25px 30px; border-bottom: 1px solid #eee; }
        .items-section h3 { color: #0f766e; margin-bottom: 15px; font-size: 16px; }
        .order-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .order-item:last-child { border-bottom: none; }
        .order-item .name { color: #333; }
        .order-item .price { font-weight: 600; color: #0f766e; }
        
        .totals-section { background: #f9f9f9; padding: 20px 30px; }
        .total-row { display: flex; justify-content: space-between; padding: 8px 0; }
        .total-row.final { border-top: 2px solid #ddd; margin-top: 10px; padding-top: 15px; font-size: 20px; font-weight: 700; }
        .total-row.final .amount { color: #0f766e; }
        
        .payment-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .payment-cod { background: #e5e7eb; color: #374151; }
        .payment-gcash { background: #dbeafe; color: #1e40af; }
        
        .contact-section { padding: 25px 30px; text-align: center; }
        .contact-section p { color: #666; margin-bottom: 15px; }
        .contact-btn { display: inline-block; padding: 12px 30px; background: #0f766e; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; }
        .contact-btn:hover { background: #134e4a; }
        
        /* Cancel Button */
        .cancel-section { padding: 20px 30px; text-align: center; border-top: 1px solid #eee; }
        .cancel-btn { padding: 12px 30px; background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .cancel-btn:hover { background: #fecaca; }
        
        .loading { text-align: center; padding: 60px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f0f0f0; border-top-color: #0f766e; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error-card { background: white; border-radius: 16px; padding: 60px 30px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .error-card .icon { font-size: 60px; margin-bottom: 20px; }
        .error-card h2 { color: #dc2626; margin-bottom: 10px; }
        .error-card p { color: #666; }
        
        @media (max-width: 600px) {
            .search-form { flex-direction: column; }
            .info-grid { grid-template-columns: 1fr; }
            .timeline-label { font-size: 10px; }
            .timeline-dot { width: 32px; height: 32px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo"><a href="/">Amadeo Marketplace</a></div>
            <a href="/">Back to Shop</a>
        </div>
    </header>
    
    <main class="main-content">
        <div class="search-card">
            <h1>Track Your Order</h1>
            <p>Enter your Order ID to check the status</p>
            <div class="search-form">
                <input type="text" id="orderIdInput" placeholder="ORD-XXXXXXXX" maxlength="20">
                <button onclick="trackOrder()">Track</button>
            </div>
        </div>
        
        <div class="loading" id="loadingState" style="display:none;">
            <div class="spinner"></div>
            <p>Looking up your order...</p>
        </div>
        
        <div class="error-card" id="errorState" style="display:none;">
            <div class="icon">üîç</div>
            <h2>Order Not Found</h2>
            <p>Please check your Order ID and try again</p>
        </div>
        
        <div class="order-card" id="orderCard">
            <div class="order-header">
                <div class="order-id-label">Order ID</div>
                <div class="order-id" id="displayOrderId">ORD-XXXXXXXX</div>
                <div class="order-date" id="displayDate">Placed on: --</div>
            </div>
            
            <div class="status-section">
                <h3>Order Status</h3>
                <div class="timeline" id="timeline">
                    <div class="timeline-progress" id="timelineProgress"></div>
                    <div class="timeline-step" data-step="1">
                        <div class="timeline-dot">üìù</div>
                        <div class="timeline-label">Placed</div>
                    </div>
                    <div class="timeline-step" data-step="2">
                        <div class="timeline-dot">‚úÖ</div>
                        <div class="timeline-label">Confirmed</div>
                    </div>
                    <div class="timeline-step" data-step="3">
                        <div class="timeline-dot">üë®‚Äçüç≥</div>
                        <div class="timeline-label">Preparing</div>
                    </div>
                    <div class="timeline-step" data-step="4">
                        <div class="timeline-dot">üõµ</div>
                        <div class="timeline-label">Delivery</div>
                    </div>
                    <div class="timeline-step" data-step="5">
                        <div class="timeline-dot">üéâ</div>
                        <div class="timeline-label">Complete</div>
                    </div>
                </div>
                
                <div class="current-status" id="currentStatus">
                    <div class="status-icon">üì¶</div>
                    <div class="status-text">Pending</div>
                    <div class="status-desc">Waiting for merchant confirmation</div>
                </div>
            </div>
            
            <div class="info-section">
                <h3>Delivery Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Customer Name</label>
                        <p id="displayName">--</p>
                    </div>
                    <div class="info-item">
                        <label>Phone</label>
                        <p id="displayPhone">--</p>
                    </div>
                    <div class="info-item">
                        <label>Address</label>
                        <p id="displayAddress">--</p>
                    </div>
                    <div class="info-item">
                        <label>Barangay</label>
                        <p id="displayBarangay">--</p>
                    </div>
                </div>
            </div>
            
            <div class="items-section">
                <h3>Order Items</h3>
                <div id="orderItems"></div>
            </div>
            
            <div class="totals-section">
                <div class="total-row">
                    <span>Subtotal</span>
                    <span id="displaySubtotal">P0</span>
                </div>
                <div class="total-row">
                    <span>Platform Fee</span>
                    <span id="displayFee">FREE</span>
                </div>
                <div class="total-row final">
                    <span>Total</span>
                    <span class="amount" id="displayTotal">P0</span>
                </div>
            </div>
            
            <div class="info-section">
                <h3>Payment</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Method</label>
                        <p><span class="payment-badge" id="displayPayment">COD</span></p>
                    </div>
                    <div class="info-item">
                        <label>Status</label>
                        <p id="displayPaymentStatus">Pending</p>
                    </div>
                </div>
            </div>
            
            <div class="cancel-section" id="cancelSection" style="display:none;">
                <button class="cancel-btn" onclick="cancelOrder()">Cancel Order</button>
                <p style="font-size:12px;color:#999;margin-top:10px;">You can only cancel orders that are still pending</p>
            </div>
            
            <div class="contact-section">
                <p>Need help with your order?</p>
                <a href="tel:09669606060" class="contact-btn">Call 0966 960 6060</a>
            </div>
        </div>
    </main>
    
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzFo0Y_OPRZ4h9pr8lqqShRgT7NCnPSVTXf96LJ_x6DjKqUKzAAzwFkbq8NjGZAJVmncw/exec';
        
        let currentOrder = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check URL for order ID
            const params = new URLSearchParams(window.location.search);
            const orderId = params.get('id');
            if (orderId) {
                document.getElementById('orderIdInput').value = orderId;
                trackOrder();
            }
            
            // Enter key support
            document.getElementById('orderIdInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') trackOrder();
            });
        });
        
        async function trackOrder() {
            const orderId = document.getElementById('orderIdInput').value.trim().toUpperCase();
            if (!orderId) {
                alert('Please enter an Order ID');
                return;
            }
            
            // Show loading
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('orderCard').classList.remove('active');
            
            try {
                const response = await fetch(SCRIPT_URL + '?action=getOrder&orderId=' + orderId);
                const data = await response.json();
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (data.success && data.data) {
                    currentOrder = data.data;
                    displayOrder(data.data);
                } else {
                    document.getElementById('errorState').style.display = 'block';
                }
            } catch (error) {
                console.error('Track error:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorState').style.display = 'block';
            }
        }
        
        function displayOrder(order) {
            document.getElementById('orderCard').classList.add('active');
            
            // Header
            document.getElementById('displayOrderId').textContent = order.OrderId;
            document.getElementById('displayDate').textContent = 'Placed on: ' + new Date(order.CreatedAt).toLocaleString();
            
            // Customer info
            document.getElementById('displayName').textContent = order.CustomerName;
            document.getElementById('displayPhone').innerHTML = `<a href="tel:${order.CustomerPhone}">${order.CustomerPhone}</a>`;
            document.getElementById('displayAddress').textContent = order.CustomerAddress;
            document.getElementById('displayBarangay').textContent = order.Barangay;
            
            // Items
            let items = [];
            try { items = JSON.parse(order.Items || '[]'); } catch(e) {}
            
            document.getElementById('orderItems').innerHTML = items.map(item => `
                <div class="order-item">
                    <span class="name">${item.name} x${item.quantity}</span>
                    <span class="price">P${(item.price * item.quantity).toLocaleString()}</span>
                </div>
            `).join('');
            
            // Totals
            document.getElementById('displaySubtotal').textContent = 'P' + (order.Subtotal || 0).toLocaleString();
            const isGcash = order.PaymentMethod === 'GCash';
            document.getElementById('displayFee').textContent = isGcash ? 'P' + (order.PlatformFee || 0).toLocaleString() : 'FREE';
            document.getElementById('displayFee').style.color = isGcash ? '#ef4444' : '#10b981';
            document.getElementById('displayTotal').textContent = 'P' + (order.Total || 0).toLocaleString();
            
            // Payment
            const paymentBadge = document.getElementById('displayPayment');
            paymentBadge.textContent = order.PaymentMethod || 'COD';
            paymentBadge.className = 'payment-badge payment-' + (order.PaymentMethod?.toLowerCase() || 'cod');
            document.getElementById('displayPaymentStatus').textContent = order.PaymentStatus || 'Pending';
            
            // Status
            updateTimeline(order.OrderStatus);
            
            // Show cancel button only for Pending orders
            const cancelSection = document.getElementById('cancelSection');
            if (order.OrderStatus === 'Pending') {
                cancelSection.style.display = 'block';
            } else {
                cancelSection.style.display = 'none';
            }
        }
        
        function updateTimeline(status) {
            const statusMap = {
                'Pending': 1,
                'Confirmed': 2,
                'Preparing': 3,
                'Out for Delivery': 4,
                'Delivered': 5,
                'Completed': 5,
                'Cancelled': 0
            };
            
            const statusInfo = {
                'Pending': { icon: 'üì¶', text: 'Order Pending', desc: 'Waiting for merchant confirmation' },
                'Confirmed': { icon: '‚úÖ', text: 'Order Confirmed', desc: 'Merchant has accepted your order' },
                'Preparing': { icon: 'üë®‚Äçüç≥', text: 'Preparing', desc: 'Your order is being prepared' },
                'Out for Delivery': { icon: 'üõµ', text: 'Out for Delivery', desc: 'Your order is on the way!' },
                'Delivered': { icon: 'üì¨', text: 'Delivered', desc: 'Your order has been delivered' },
                'Completed': { icon: 'üéâ', text: 'Completed', desc: 'Thank you for your order!' },
                'Cancelled': { icon: '‚ùå', text: 'Cancelled', desc: 'This order has been cancelled' }
            };
            
            const currentStep = statusMap[status] || 1;
            const info = statusInfo[status] || statusInfo['Pending'];
            
            // Update timeline steps
            document.querySelectorAll('.timeline-step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('completed', 'active', 'cancelled');
                
                if (status === 'Cancelled') {
                    step.classList.add('cancelled');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });
            
            // Update progress bar
            const progress = document.getElementById('timelineProgress');
            const progressPercent = status === 'Cancelled' ? 0 : ((currentStep - 1) / 4) * 100;
            progress.style.width = progressPercent + '%';
            
            // Update current status
            const statusEl = document.getElementById('currentStatus');
            statusEl.innerHTML = `
                <div class="status-icon">${info.icon}</div>
                <div class="status-text">${info.text}</div>
                <div class="status-desc">${info.desc}</div>
            `;
            statusEl.className = 'current-status' + (status === 'Cancelled' ? ' cancelled' : '');
        }
        
        async function cancelOrder() {
            if (!currentOrder) return;
            
            if (!confirm('Are you sure you want to cancel this order?')) return;
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'updateOrderStatus',
                        orderId: currentOrder.OrderId,
                        status: 'Cancelled'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Order cancelled successfully');
                    trackOrder();
                } else {
                    alert('Error: ' + (result.error || 'Could not cancel order'));
                }
            } catch (error) {
                alert('Network error. Please try again.');
            }
        }
    </script>
</body>
</html>
