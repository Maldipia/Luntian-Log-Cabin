<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luntian Booking Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .booking-cell {
            min-height: 80px;
            transition: all 0.2s;
        }
        .booking-cell:hover {
            background-color: #f0fdf4;
        }
        .booking-bar {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .booking-bar:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .room-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Password (change this)
        const ADMIN_PASSWORD = "luntian2025";

        // Room configuration
        const ROOMS = [
            { id: 'sunrise', name: 'Sunrise Room', color: 'bg-orange-500', lightColor: 'bg-orange-100', emoji: 'üü†', price: 3800 },
            { id: 'leaf', name: 'Leaf Room', color: 'bg-green-500', lightColor: 'bg-green-100', emoji: 'üü¢', price: 3800 },
            { id: 'yani', name: 'Yani Room', color: 'bg-blue-500', lightColor: 'bg-blue-100', emoji: 'üîµ', price: 2499 }
        ];

        const PLATFORMS = ['Airbnb', 'Booking.com', 'Agoda', 'Direct', 'WhatsApp'];

        // State management
        let state = {
            isLoggedIn: sessionStorage.getItem('luntianAuth') === 'true',
            currentDate: new Date(),
            bookings: JSON.parse(localStorage.getItem('luntianBookings') || '[]'),
            showModal: false,
            editingBooking: null
        };

        // Save bookings to localStorage
        function saveBookings() {
            localStorage.setItem('luntianBookings', JSON.stringify(state.bookings));
        }

        // Date utilities
        function getDaysInMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        }

        function getFirstDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function parseDate(dateStr) {
            return new Date(dateStr + 'T00:00:00');
        }

        // Check if booking overlaps with dates
        function getBookingForRoomAndDate(roomId, dateStr) {
            return state.bookings.find(b => {
                if (b.room !== roomId) return false;
                const checkIn = new Date(b.checkIn);
                const checkOut = new Date(b.checkOut);
                const date = new Date(dateStr);
                return date >= checkIn && date < checkOut;
            });
        }

        // Export to Excel
        function exportToExcel() {
            const data = state.bookings.map(b => ({
                'Guest Name': b.guestName,
                'Email': b.email || '',
                'Phone': b.phone || '',
                'Room': ROOMS.find(r => r.id === b.room)?.name || b.room,
                'Check-in': b.checkIn,
                'Check-out': b.checkOut,
                'Nights': Math.ceil((new Date(b.checkOut) - new Date(b.checkIn)) / (1000 * 60 * 60 * 24)),
                'Guests': b.guests || 2,
                'Price': b.price,
                'Platform': b.platform,
                'Notes': b.notes || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Bookings");
            XLSX.writeFile(wb, `Luntian_Bookings_${formatDate(new Date())}.xlsx`);
        }

        // Import from CSV
        function importFromCSV(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);
                
                rows.forEach(row => {
                    const roomName = row['Room'] || row['room'];
                    const room = ROOMS.find(r => r.name.toLowerCase().includes(roomName?.toLowerCase()))?.id || 'sunrise';
                    
                    state.bookings.push({
                        id: Date.now() + Math.random(),
                        guestName: row['Guest Name'] || row['guest'] || 'Guest',
                        email: row['Email'] || row['email'] || '',
                        phone: row['Phone'] || row['phone'] || '',
                        room: room,
                        checkIn: row['Check-in'] || row['checkin'],
                        checkOut: row['Check-out'] || row['checkout'],
                        guests: row['Guests'] || row['guests'] || 2,
                        price: row['Price'] || row['price'] || ROOMS.find(r => r.id === room)?.price || 3800,
                        platform: row['Platform'] || row['platform'] || 'Direct',
                        notes: row['Notes'] || row['notes'] || ''
                    });
                });
                
                saveBookings();
                render();
            };
            reader.readAsArrayBuffer(file);
        }

        // Login component
        function LoginScreen() {
            let password = '';
            let error = '';

            return `
                <div class="min-h-screen bg-gradient-to-br from-green-400 via-emerald-500 to-teal-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üè°</div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Luntian Calendar</h1>
                            <p class="text-gray-600">Booking Management System</p>
                        </div>

                        <div class="mb-6">
                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-6">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">üîí</span>
                                    <div>
                                        <p class="font-semibold text-gray-800 mb-1">Admin Access Only</p>
                                        <p class="text-sm text-gray-600">Enter password to manage bookings</p>
                                    </div>
                                </div>
                            </div>

                            <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <input
                                type="password"
                                id="password-input"
                                placeholder="Enter password"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                                autofocus
                            />

                            <div id="error-message" class="mt-3 hidden bg-red-50 border-2 border-red-200 rounded-xl p-3 flex items-center gap-2">
                                <span class="text-xl">‚ùå</span>
                                <p class="text-red-700 text-sm font-medium">Incorrect password</p>
                            </div>
                        </div>

                        <button
                            onclick="handleLogin()"
                            class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 rounded-xl font-bold text-lg hover:from-green-700 hover:to-emerald-700 transition shadow-lg"
                        >
                            üîì Login
                        </button>

                        <div class="mt-6 text-center">
                            <a href="/" class="text-green-600 hover:text-green-700 font-medium text-sm">
                                ‚Üê Back to Website
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        // Calendar component
        function CalendarView() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            const daysInMonth = getDaysInMonth(state.currentDate);
            const firstDay = getFirstDayOfMonth(state.currentDate);
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            // Calculate stats
            const totalBookings = state.bookings.length;
            const totalRevenue = state.bookings.reduce((sum, b) => sum + (b.price || 0), 0);
            const avgRate = totalBookings > 0 ? totalRevenue / totalBookings : 0;

            let calendarHTML = `
                <div class="min-h-screen bg-gray-50 p-4">
                    <div class="max-w-7xl mx-auto">
                        <!-- Header -->
                        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                                <div>
                                    <h1 class="text-4xl font-bold text-gray-800">üè° Luntian Calendar</h1>
                                    <p class="text-gray-600 mt-1">Tagaytay Log Cabin - Booking Management</p>
                                </div>
                                <div class="flex gap-3 flex-wrap">
                                    <button onclick="exportToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                                        üìä Export Excel
                                    </button>
                                    <label class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition cursor-pointer">
                                        üì• Import CSV
                                        <input type="file" accept=".csv,.xlsx,.xls" onchange="handleImport(event)" class="hidden" />
                                    </label>
                                    <button onclick="showAddBookingModal()" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition">
                                        ‚ûï Add Booking
                                    </button>
                                    <button onclick="handleLogout()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
                                        üîí Logout
                                    </button>
                                </div>
                            </div>

                            <!-- Stats -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-gradient-to-br from-blue-400 to-blue-600 text-white p-6 rounded-xl">
                                    <div class="text-3xl font-bold">${totalBookings}</div>
                                    <div class="text-sm opacity-90">Total Bookings</div>
                                </div>
                                <div class="bg-gradient-to-br from-green-400 to-green-600 text-white p-6 rounded-xl">
                                    <div class="text-3xl font-bold">‚Ç±${totalRevenue.toLocaleString()}</div>
                                    <div class="text-sm opacity-90">Total Revenue</div>
                                </div>
                                <div class="bg-gradient-to-br from-orange-400 to-orange-600 text-white p-6 rounded-xl">
                                    <div class="text-3xl font-bold">‚Ç±${Math.round(avgRate).toLocaleString()}</div>
                                    <div class="text-sm opacity-90">Average Rate</div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Navigation -->
                        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <button onclick="previousMonth()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold transition">
                                    ‚Üê Previous
                                </button>
                                <h2 class="text-3xl font-bold text-gray-800">
                                    ${monthNames[month]} ${year}
                                </h2>
                                <button onclick="nextMonth()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold transition">
                                    Next ‚Üí
                                </button>
                            </div>

                            <!-- Calendar Grid -->
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse">
                                    <thead>
                                        <tr>
                                            <th class="border-2 border-gray-300 p-2 bg-gray-100 font-bold w-32">Room</th>
            `;

            // Day headers
            for (let i = 0; i < daysInMonth; i++) {
                const date = new Date(year, month, i + 1);
                const dayName = dayNames[date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                calendarHTML += `
                    <th class="border-2 border-gray-300 p-2 ${isWeekend ? 'bg-blue-50' : 'bg-gray-50'} text-center min-w-[60px]">
                        <div class="text-xs text-gray-600">${dayName}</div>
                        <div class="text-lg font-bold">${i + 1}</div>
                    </th>
                `;
            }

            calendarHTML += `
                                        </tr>
                                    </thead>
                                    <tbody>
            `;

            // Room rows
            ROOMS.forEach(room => {
                calendarHTML += `
                    <tr>
                        <td class="border-2 border-gray-300 p-3 bg-gray-50 font-bold room-header">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${room.emoji}</span>
                                <div>
                                    <div class="text-sm">${room.name}</div>
                                    <div class="text-xs text-gray-600">‚Ç±${room.price.toLocaleString()}/night</div>
                                </div>
                            </div>
                        </td>
                `;

                // Day cells
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const booking = getBookingForRoomAndDate(room.id, dateStr);
                    
                    if (booking) {
                        const checkInDate = booking.checkIn;
                        const isFirstDay = dateStr === checkInDate;
                        
                        if (isFirstDay) {
                            const nights = Math.ceil((new Date(booking.checkOut) - new Date(booking.checkIn)) / (1000 * 60 * 60 * 24));
                            calendarHTML += `
                                <td colspan="${nights}" class="border-2 border-gray-300 p-2 ${room.lightColor} booking-cell">
                                    <div onclick="editBooking(${booking.id})" class="booking-bar ${room.color} text-white p-2 rounded-lg shadow-md">
                                        <div class="font-bold text-sm">${booking.guestName}</div>
                                        <div class="text-xs opacity-90">${booking.platform}</div>
                                        <div class="text-xs opacity-90">${nights} night${nights > 1 ? 's' : ''} ¬∑ ‚Ç±${booking.price.toLocaleString()}</div>
                                    </div>
                                </td>
                            `;
                            day += nights - 1;
                        }
                    } else {
                        calendarHTML += `
                            <td class="border-2 border-gray-300 p-2 booking-cell hover:bg-green-50 cursor-pointer" onclick="quickAddBooking('${room.id}', '${dateStr}')">
                                <div class="text-center text-gray-400 text-xs">+</div>
                            </td>
                        `;
                    }
                }

                calendarHTML += `
                    </tr>
                `;
            });

            calendarHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return calendarHTML;
        }

        // Booking modal
        function BookingModal() {
            if (!state.showModal) return '';

            const booking = state.editingBooking || {
                guestName: '',
                email: '',
                phone: '',
                room: 'sunrise',
                checkIn: formatDate(state.currentDate),
                checkOut: formatDate(new Date(state.currentDate.getTime() + 86400000)),
                guests: 2,
                price: 3800,
                platform: 'Direct',
                notes: ''
            };

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closeModal(event)">
                    <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">
                                ${state.editingBooking ? '‚úèÔ∏è Edit Booking' : '‚ûï Add New Booking'}
                            </h2>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>

                        <form id="booking-form" onsubmit="saveBooking(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Guest Name *</label>
                                    <input type="text" name="guestName" value="${booking.guestName}" required
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                    <input type="email" name="email" value="${booking.email || ''}"
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                                    <input type="tel" name="phone" value="${booking.phone || ''}"
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Room *</label>
                                    <select name="room" required class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        ${ROOMS.map(r => `<option value="${r.id}" ${booking.room === r.id ? 'selected' : ''}>${r.emoji} ${r.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Check-in *</label>
                                    <input type="date" name="checkIn" value="${booking.checkIn}" required
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Check-out *</label>
                                    <input type="date" name="checkOut" value="${booking.checkOut}" required
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Guests *</label>
                                    <input type="number" name="guests" value="${booking.guests}" min="1" max="10" required
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Price (‚Ç±) *</label>
                                    <input type="number" name="price" value="${booking.price}" min="0" required
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Platform *</label>
                                    <select name="platform" required class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        ${PLATFORMS.map(p => `<option value="${p}" ${booking.platform === p ? 'selected' : ''}>${p}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                                <textarea name="notes" rows="3" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">${booking.notes || ''}</textarea>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">
                                    üíæ Save Booking
                                </button>
                                ${state.editingBooking ? `
                                    <button type="button" onclick="deleteBooking(${state.editingBooking.id})" class="px-6 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition">
                                        üóëÔ∏è Delete
                                    </button>
                                ` : ''}
                                <button type="button" onclick="closeModal()" class="px-6 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400 transition">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        // Event handlers
        function handleLogin() {
            const password = document.getElementById('password-input').value;
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('luntianAuth', 'true');
                state.isLoggedIn = true;
                render();
            } else {
                document.getElementById('error-message').classList.remove('hidden');
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('luntianAuth');
            state.isLoggedIn = false;
            render();
        }

        function previousMonth() {
            state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() - 1, 1);
            render();
        }

        function nextMonth() {
            state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth() + 1, 1);
            render();
        }

        function showAddBookingModal() {
            state.showModal = true;
            state.editingBooking = null;
            render();
        }

        function quickAddBooking(roomId, dateStr) {
            state.showModal = true;
            state.editingBooking = {
                guestName: '',
                email: '',
                phone: '',
                room: roomId,
                checkIn: dateStr,
                checkOut: formatDate(new Date(new Date(dateStr).getTime() + 86400000)),
                guests: 2,
                price: ROOMS.find(r => r.id === roomId)?.price || 3800,
                platform: 'Direct',
                notes: ''
            };
            render();
        }

        function editBooking(bookingId) {
            const booking = state.bookings.find(b => b.id === bookingId);
            if (booking) {
                state.showModal = true;
                state.editingBooking = booking;
                render();
            }
        }

        function closeModal(event) {
            if (!event || event.target === event.currentTarget) {
                state.showModal = false;
                state.editingBooking = null;
                render();
            }
        }

        function saveBooking(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const bookingData = {
                guestName: formData.get('guestName'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                room: formData.get('room'),
                checkIn: formData.get('checkIn'),
                checkOut: formData.get('checkOut'),
                guests: parseInt(formData.get('guests')),
                price: parseFloat(formData.get('price')),
                platform: formData.get('platform'),
                notes: formData.get('notes')
            };

            if (state.editingBooking && state.editingBooking.id) {
                // Update existing
                const index = state.bookings.findIndex(b => b.id === state.editingBooking.id);
                state.bookings[index] = { ...bookingData, id: state.editingBooking.id };
            } else {
                // Add new
                state.bookings.push({ ...bookingData, id: Date.now() });
            }

            saveBookings();
            closeModal();
        }

        function deleteBooking(bookingId) {
            if (confirm('Are you sure you want to delete this booking?')) {
                state.bookings = state.bookings.filter(b => b.id !== bookingId);
                saveBookings();
                closeModal();
            }
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                importFromCSV(file);
            }
        }

        // Render function
        function render() {
            const app = document.getElementById('app');
            if (!state.isLoggedIn) {
                app.innerHTML = LoginScreen();
                // Add enter key listener
                setTimeout(() => {
                    const input = document.getElementById('password-input');
                    if (input) {
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') handleLogin();
                        });
                    }
                }, 0);
            } else {
                app.innerHTML = CalendarView() + BookingModal();
            }
        }

        // Initial render
        render();
    </script>
</body>
</html>
